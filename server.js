const TelegramBot = require('node-telegram-bot-api');
require('dotenv').config();

const getLastNews = require('./components/tj');
const getYesterdayShows = require('./components/myshows');

const token = process.env.BOT_TOKEN;
const chatId = process.env.BOT_CHAT_ID;

const myshowsLogin = process.env.MYSHOWS_LOGIN;
const myshowsPassword = process.env.MYSHOWS_PASSWORD;

const bot = new TelegramBot(token, {
    polling: true
});

bot.on('message', async (msg) => {
    const chatId = msg.chat.id;
    let news = [];
    let shows = [];

    const getSuccess = lastNews => {
        news = lastNews;
    };

    const getSuccessShows = lastShows => {
        shows = lastShows;
    };

    await getLastNews().then(getSuccess);
    await getYesterdayShows(myshowsLogin, myshowsPassword).then(getSuccessShows);

    let message = `<b>–î–æ–±—Ä–æ–π –Ω–æ—á–∫–∏, —Ä–µ–±—è—Ç–∞! –í–æ—Ç –∏ –∏—Ç–æ–≥–∏ –¥–Ω—è:</b> \n\n<b>–°–µ—Ä–∏–∞–ª—ã:</b>\n`;

    if (shows.length) {
        shows.forEach(({ showId, show, name, episodes }, index) => {
            message += `<b>${index+1}.</b> ${name} –ø–æ—Å–º–æ—Ç—Ä–µ–ª ${episodes} —ç–ø–∏–∑–æ–¥–æ–≤ —Å–µ—Ä–∏–∞–ª–∞ <a href="https://myshows.me/view/${showId}">${show}</a>\n`
        });
    } else {
        message += '–°–µ—Ä–∏–∞–ª—ã —Å–µ–≥–æ–¥–Ω—è –Ω–∏–∫—Ç–æ –Ω–µ —Å–º–æ—Ç—Ä–µ–ª\n\n'
    }

    message += `\n<b>–¢–æ–ø –Ω–æ–≤–æ—Å—Ç–µ–π c TJ:\n</b>`;

    news.forEach(({ title, badges, url, image }, index) => {
        message += `<b>${index+1}.</b> ${title} <a href="${url}">üîó</a>\n\n`
    });

    bot.sendMessage(chatId, message, {
        parse_mode: 'HTML'
    });
});

bot.on('polling_error', (err) => console.log(err));
